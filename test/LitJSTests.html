<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Literate JS Tests</title>
  <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.18.0.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="../js/literate.js"></script>
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="http://code.jquery.com/qunit/qunit-1.18.0.js"></script>
  <script>
  
	var _ = QUnit;
  
  
	function mockScript(script,assertionBlock)
	{
		return function(selector)
		{
			if (assertionBlock) assertionBlock(selector);
			return script ? [{innerText : script, parentElement: {attributes:{}}}] : [];
		}
	}
	
	_.module("Script Blocks")
    _.test( "Flow of script block evaluation", function( assert ) 
	{
		assert.expect(3)
		var testScript = "var x = 5"
		var expectedScript = "try {\n" + testScript + "\n}\ncatch (exn) {\nalert('Error in block block_0: ' + exn);\n}";
		var mockJQ = mockScript(testScript,
						function(selector) { assert.deepEqual(selector,'pre code', "Looks for 'pre code' elements"); })
		
		var mockDoc = 
		{
			createElement : function(tag) { assert.deepEqual(tag,"script", "Creates a 'script' tag"); return {  }; },
			head : {
				appendChild : function(js) {
					assert.deepEqual(js.text,expectedScript, 'appends script elements to head')
				}
			}
		};
		
		LitJS.evalScriptBlocks(mockJQ,mockDoc)
    });
	
	_.test("Evaluating a simple block", function(assert) 
	{
		LitJS.evalScriptBlocks(mockScript("var x = 5"));
		assert.ok( x == 5,"Should have a variable named x with the value of 5")
	});
	
	_.test("Evaluates multi-line script", function(assert) {
		var testScript = "var x = 5 \n var y = x + 2"
		
		LitJS.evalScriptBlocks(mockScript(testScript));
		assert.ok(y == 7, "Should evaluate y to 7")
	})
	
	_.test("No code blocks ==> should not create new script tags",function(assert) {
		assert.expect(0)
		var mockDoc = {
			createElement : function(tag) { assert.ok(false,"createElement shouldn't be called")},
			head : {
				appendChild : function(js) { assert.ok(false, "document.head.appendChild shouldn't be called")}
			}
		}
		LitJS.evalScriptBlocks(mockScript(),mockDoc)
	})
	
	_.test("A script block with a title should have a header", function(assert) {
		var testScript = "var y = 38";
		var testTitle = "Test Title"
		var blockID = "blockID" //also testing for insertion of custom block ID
		var mockJQ = function(selector) 
		{
			if (typeof(selector) == 'string')
			{
				assert.deepEqual(selector,"pre code","Selects 'pre code' elements")
				return [{innerText : testScript, parentElement : { id:blockID,title : testTitle, attributes : {}}}]
			}
			else //wrapping an object
			{
				return {
					wrap : function(html) { 
						assert.deepEqual(html,"<div class='panel panel-info'><div class='panel-body' id='"+blockID+"'></div></div>",
									"Creates divs with correct styles");
					},
					parent : function() {
						return {
							before : function(html) {
								assert.deepEqual(html,"<div class='panel-heading'>" + (testTitle) + "</div>",
												 "Creates a heading with the passed title and correct styles")
							}
						}
					}
				}
			}
		}
		LitJS.evalScriptBlocks(mockJQ);
	})
	
	_.module("Inline Expressions")
	_.test("Flow of inline script evaluation", function(assert){
		assert.expect(2)
		var testScript = "Math.sqrt(16)";

		var mockExprEl = {innerText : testScript}
		var mockJQ = function(selector)
		{
			assert.deepEqual(selector,'code.inline', "Looks for 'code.inline' elements");
			return [mockExprEl];
		}
		
		LitJS.evalInline(mockJQ);
		assert.deepEqual(mockExprEl.innerText,4,"Should switch element's inner text to script evaluation result")
	})
  </script>
</body>
</html>